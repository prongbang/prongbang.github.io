---
layout: post
title:  "[Golang] มาใช้ Wire เพื่อช่วยทำ Dependency Injection กันเถอะ"
short_description: "บล็อคนี้ไม่อยากพิมพ์เยอะ เพราะวิธีใช้มันน้อย และง่ายมาก ๆ"
date:   2019-11-10 01:15:00 +0700
categories: [golang]
tags: [golang]
cover_image: /assets/images/golang/9.png
author: "end try"
---

### เริ่มจากสร้างโปรเจค และวางโครงตามนี้ หรือจะทำแบบที่ตัวเองถนัดก็ได้

<br>
{% highlight bash %}
wire-todos
|____cmd
| |____main.go
|____pkg
| |____todo
| | |____wire.go
| | |____todo.go
| | |____repository.go
| | |____usecase.go
{% endhighlight %}

### มาดูว่าแต่ละโฟลเดอร์ และไฟล์ใช้ทำอะไรบ้าง

- `cmd` ย่อมาจาก command สำหรับเก็บไฟล์ที่ต้องใช้คำสั่งต่าง ๆ เพื่อสั่งอะไรบางอย่างให้ทำงาน <br>
- `pkg` ย่อมาจาก package สำหรับเก็บ package หรือ folder ที่สร้างขึ้นมาตาม feature เพื่อทำงานอะไรบางอย่างตาม requirement<br>
- `todo` คือชื่อ package หรือชื่อ feature<br>
- `wire.go` สำหรับทำ Dependency Injection เพื่อ provide method ต่าง ๆ โดยที่เราไม่ต้องไปทำเอง<br>
- `todo.go` คือ model<br>
- `repository.go` คือ เป็นส่วนที่ใช้จัดการกับ DataSource ว่าจะดึงข้อมูลจาก cache หรือ database ให้มันอยู่เป็นที่เป็นทาง<br>
- `usecase.go` คือ เป็นส่วนที่เก็บ Business Logic ที่ทำงานเฉพาะเจาะจง<br>

### จากนั้นให้เราลง wire โดยรันคำสั่งตามนี้

{% highlight bash %}
$ go get -u github.com/google/wire/cmd/wire
{% endhighlight %}

### จากนั้นก็มาเริ่มเขียน code แบบแต่ละไฟล์ประมาณนี้

- `todo.go` ไฟล์ model โดยเราจะสร้างประมาณนี้ ที่จริงจะเป็นอะไรก็ได้ขึ้นอยู่กับ requirement

{% highlight golang %}
package todo

type Todo struct {
	ID        int    `json:"id"`
	UserID    int    `json:"userId"`
	Title     string `json:"title"`
	Completed bool   `json:"completed"`
}
{% endhighlight %}

- `repository.go` ในที่นี้จะจำลองว่ามีการดึงข้อมูลจาก cache โดยการฟิกค่าไว้

{% highlight golang %}
package todo

type Repository interface {
	FindAll() []Todo
}

type repository struct {
}

func NewRepository() Repository {
	return &repository{}
}

func (r *repository) FindAll() []Todo {
	return []Todo{
		Todo{
			ID:        1,
			UserID:    1,
			Title:     "Todo 1",
			Completed: true,
		},
		Todo{
			ID:        2,
			UserID:    1,
			Title:     "Todo 2",
			Completed: false,
		},
	}
}
{% endhighlight %}

- `usecase.go` ในที่นี้จะทำการเรียกใช้ repository อย่างเดียว

{% highlight golang %}
package todo

type UseCase interface {
	GetTodoList() []Todo
}

type useCase struct {
	Repo Repository
}

func NewUseCase(repo Repository) UseCase {
	return &useCase{
		Repo: repo,
	}
}

func (u *useCase) GetTodoList() []Todo {
	return u.Repo.FindAll()
}
{% endhighlight %}

### ต่อไปจะเป็นการใช้ wire มาช่วยทำ Dependency Injection เพียงเขียนเท่านี้

{% highlight golang %}
//+build wireinject

package todo

import "github.com/google/wire"

func Initial() (UseCase, error) {
	wire.Build(NewUseCase, NewRepository)
	return nil, nil
}
{% endhighlight %}

โดยสิ่งที่จำเป็นต้องใส่คือ `//+build wireinject` เพื่อบอกกับ wire เพื่อไม่ให้มัน error `Initial redeclared in this block previous declaration at ../pkg/todo/wire.go:5:26` เวลามีการเรียกใช้ `todo.Initial()`<br><br>

### ต่อไปจะเป็นการ gen ไฟล์ โดยใช้คำสั่งตามนี้

- เริ่มจากเข้าไปที่ folder ที่จะให้ wire gen ไฟล์สำหรับ provide method ให้เรา โดยเข้าไปที่

{% highlight golang %}
$ cd wire-todos/pkg/todo
{% endhighlight %}

- ทำการ gen ไฟล์โดยใช้คำสั่งตามนี้

{% highlight golang %}
$ wire
{% endhighlight %}

- ถ้า gen ไฟล์ success จะได้ไฟล์ที่ชื่อว่า `wire_gen.go` ประมาณนี้

{% highlight golang %}
// Code generated by Wire. DO NOT EDIT.

//go:generate wire
//+build !wireinject

package todo

// Injectors from wire.go:

func Initial() (UseCase, error) {
	todoRepository := NewRepository()
	todoUseCase := NewUseCase(todoRepository)
	return todoUseCase, nil
}
{% endhighlight %}

จะเห็นว่าเราไม่ต้องทำการ สร้าง method เพื่อ provide เองเลย<br><br>

### ต่อไปเป็นการเรียกใช้ที่ไฟล์ `main.go` ประมาณนี้

{% highlight golang %}
package main

import (
	"log"

	"github.com/prongbang/wire-todos/pkg/todo"
)

func main() {
	todos, err := todo.Initial()
	if err != nil {
		log.Println("Is error")
	}
	log.Println(todos.GetTodoList())
}
{% endhighlight %}

- ลองรันด้วยคำสั่ง

{% highlight golang %}
$ go run main.go
{% endhighlight %}

จะได้ผลลัพธ์ประมาณนี้

{% highlight golang %}
2019/11/10 13:11:38 [{1 1 Todo 1 true} {2 1 Todo 2 false}]
{% endhighlight %}

เพียงเท่านี้ก็เรียบร้อยสำหรับการใช้งาน wire ในการช่วยทำ Dependency Injection สำหรับภาษา golang หากผิดพลาดประการใดต้องขออภัย ณ ที่นั้นด้วย ส่วน [Source Code](https://raboninco.com/XBt3) สามารถจิ้มเข้าไปดูแบบเต็มได้
